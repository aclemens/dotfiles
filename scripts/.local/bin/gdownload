#!/bin/bash

set -euo pipefail
source $HOME/.bash_functions

DATA_DIR="/mnt/data"
DOWNLOADS_FILE="$DATA_DIR/gallery-downloads.txt"
NEWEST_IMAGES_DIR="$DATA_DIR/gallery-dl/newest_images"

check_paths "$DATA_DIR" "$NEWEST_IMAGES_DIR" "$DOWNLOADS_FILE"
check_dependencies gallery-dl uv yazi fzf

cd "$DATA_DIR"

# read sources from $DOWNLOADS_FILE using fzf multi selection
mapfile -t sources < <(
  # filter out commented and empty lines and sort uniquely
  grep -Ev '^\s*#|^\s*$' "$DOWNLOADS_FILE" | sort -u |
    fzf \
      --header "Sources" \
      --footer "Gallery Downloader" \
      --margin 30%,25% \
      --border \
      --info inline \
      --layout reverse \
      --multi \
      --bind ctrl-a:select-all,ctrl-d:deselect-all
)

if [ ${#sources[@]} -eq 0 ]; then
  echo "No sources selected. Exiting."
  exit 0
fi

gallery-dl "${sources[@]}" || true

cd "$NEWEST_IMAGES_DIR"

uv run newest_images clean
uv run newest_images find ..

if gum confirm "Do you want to open yazi for viewing images now?"; then
  yazi "$NEWEST_IMAGES_DIR/images"
fi
