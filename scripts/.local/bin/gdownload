#!/bin/bash

set -euo pipefail
source "$HOME/.bash_functions"

DATA_DIR="/mnt/data"
DOWNLOADS_FILE="$DATA_DIR/gallery-downloads.txt"
NEWEST_IMAGES_DIR="$DATA_DIR/gallery-dl/newest_images"

# Downloads gallery items listed in gallery-downloads.txt into /mnt/data,
function download() {
  cd "$DATA_DIR"
  mapfile -t sources < <(fzf \
    --header "Sources" \
    --footer "Gallery Downloader" \
    --margin 30%,20% \
    --border \
    --info inline \
    --layout reverse \
    --multi \
    <"$DOWNLOADS_FILE")
  if [ ${#sources[@]} -eq 0 ]; then
    echo "No sources selected. Exiting."
    exit 0
  fi
  gallery-dl "${sources[@]}"
}

# runs uv tasks to collect newest images, and optionally opens them in yazi.
function regenerate_images_links() {
  cd "$NEWEST_IMAGES_DIR"
  uv run newest_images clean
  uv run newest_images find ..

  if gum confirm "Do you want to open yazi for viewing images now?"; then
    yazi "$NEWEST_IMAGES_DIR/images"
  fi
}

check_dependencies gallery-dl uv yazi fzf || exit 1
download
regenerate_images_links
