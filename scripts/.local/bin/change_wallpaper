#!/bin/bash

set -euo pipefail
source "$HOME/.bash_functions"

WALLPAPER_DIR="$HOME/Pictures/wallpapers"
CURRENT_WALLPAPER="$WALLPAPER_DIR/current_wallpaper"
YAZI_SELECTION="$HOME/Pictures/wallpapers/selected"

check_dependencies hyprctl hyprpaper yazi
check_paths "$WALLPAPER_DIR"

# Cleanup the selection file on exit
cleanup_selection() {
  echo "Cleaning up selection file..."
  rm -f "$YAZI_SELECTION"
}
trap cleanup_selection EXIT

selected_wallpaper=""
start_dir="$WALLPAPER_DIR"

# check if a parameter is given, if so check if it's a valid file or if it's a valid directory
if [ $# -eq 1 ]; then
  if [ -f "$1" ]; then
    selected_wallpaper="$1"
  elif [ -d "$1" ]; then
    start_dir="$1"
  fi
fi

if [ -z "$selected_wallpaper" ]; then
  yazi --chooser-file "$YAZI_SELECTION" "$start_dir" || exit 1
  selected_wallpaper=$(cat "$YAZI_SELECTION") || exit 1
fi

echo "Setting wallpaper to $selected_wallpaper"
ln -fs "$selected_wallpaper" "$CURRENT_WALLPAPER"
hyprctl -q hyprpaper reload ",${CURRENT_WALLPAPER}"
