#!/bin/bash

set -euo pipefail
source $HOME/.bash_functions

WALLPAPER_DIR="$HOME/Pictures/wallpapers"
CURRENT_WALLPAPER="$WALLPAPER_DIR/current_wallpaper"
YAZI_SELECTION="$HOME/Pictures/wallpapers/selected"

# Set the wallpaper using hyprpaper
function set_wallpaper() {
  local wallpaper="$1"
  echo "Setting wallpaper..."
  ln -fs "$wallpaper" "$CURRENT_WALLPAPER"
  hyprctl -q hyprpaper reload ",${CURRENT_WALLPAPER}"
}

# Select the wallpaper via yazi which has an image preview
# in terminals that support image protocols (e.g. kitty, wezterm)
function select_wallpaper() {
  yazi --chooser-file "$YAZI_SELECTION" "$WALLPAPER_DIR" || exit 1
  cat "$YAZI_SELECTION"
}

# Cleanup the selection file on exit
function cleanup_selection() {
  echo "Cleaning up selection file..."
  rm -f "$YAZI_SELECTION"
}

trap cleanup_selection EXIT

check_dependencies hyprctl hyprpaper yazi

wallpaper=$(select_wallpaper) || exit 1
set_wallpaper "$wallpaper"
